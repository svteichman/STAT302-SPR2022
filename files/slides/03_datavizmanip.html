<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>STAT 302, Lecture Slides 3</title>
    <meta charset="utf-8" />
    <meta name="author" content="Sarah Teichman (adapted from slides by Bryan Martin and Peter Gao)" />
    <link href="03_datavizmanip_files/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="gao-theme.css" type="text/css" />
    <link rel="stylesheet" href="gao-theme-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, title-slide

# STAT 302, Lecture Slides 3
## Data Visualization and Manipulation
### Sarah Teichman (adapted from slides by Bryan Martin and Peter Gao)

---






# Today's pet picture 


&lt;img src="../../files/images/pets/sansa.jpeg" width="250px" style="display: block; margin: auto;" /&gt;

Thanks Pranav!

---

# Outline

1. Introduction to tidyverse
2. Data Visualization
3. Data Manipulation

.middler[**Goal:** Learn how to go from raw data to exploratory data analysis. (Project 1!)]

---
class: inverse

.sectionhead[Part 1: Introduction to tidyverse]
---
layout: true

# tidyverse
---

The `tidyverse` is a collection of powerful R packages for data science. 
They include:

* Reading and saving data: `readr`
* Data manipulation: `tidyr`, `dplyr`
* Data visualization: `ggplot2`
* Working with different data structures: `tibble`, `purrr`, `stringr`, `forcats`

You can install them all using


```r
install.packages("tidyverse")
```

(Remember, you only need to do this once!)

---

Load them all together in your workflow documents by calling


```r
library(tidyverse)
```

---

## Conflicts?

Recall that packages are essentially ways for you to install and use functions 
written by others.
Occasionally, some of these functions have the same name and there is a conflict.
Whichever package you load more recently using `library` will mask the old function, meaning that R will default to that version.

In general, this is fine, especially with `tidyverse`. These package authors know when 
they have masked common functions in R, and typically we will prefer `tidyverse` version.

The conflict message is to make sure you know about conflicts. 
You can (and should) hide this in your R Markdown files by adding the parameter
`message=FALSE` or `include=FALSE` to your code chunk when you load packages.

---

## Conflicts?

If you want to use a function from a certain package you can use the syntax `package::function()`, for example `readr::read_csv`. This can be useful if:

* You want to use a function that is masked by a function in another package
* You want to reader of your code to know what package a function is from

---
layout: false
layout: true

# Pipes
---

&lt;img src="../../files/images/pipe.jpeg" width="600px" style="display: block; margin: auto;" /&gt;



---


**pipes** use the `%&gt;%` operator to take the output from a previous function call and "pipe" it through to the next function.
This can really help with readability of code when we use multiple nested functions!

We will use the `gapminder` data from Jenny Bryan to demonstrate throughout this section.
Load the package `gapminder` (after installing) and the corresponding data.


```r
# install.packages("gapminder")
library(gapminder)
data(gapminder)
```

---

Let's preview the data.


```r
head(gapminder, 10)
```

```
## # A tibble: 10 × 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
```


---


## Functions in Functions

What if we want the mean log population within our data set? 
Using base R, we might type


```r
mean(log(gapminder$pop))
```

```
## [1] 15.76611
```

With pipes, we can use


```r
gapminder$pop %&gt;%
  log() %&gt;%
  mean()
```

```
## [1] 15.76611
```

---

## Functions in Functions

Both of these are acceptable. However, when we start adding more and more functions,
pipes can make your code much easier and more natural to read.

---
layout: false

# Filtering data

Very commonly, we will want to filter our data to restrict what we plot or analyze.
For example, what if we are only interested in data from China since 1970?


```r
head(gapminder$country == "China" &amp; gapminder$year &gt;= 1970)
```

```
## [1] FALSE FALSE FALSE FALSE FALSE FALSE
```

```r
china_1980 &lt;- gapminder %&gt;% 
  filter(country == "China" &amp;
           year &gt;= 1970)
china_1980
```

```
## # A tibble: 8 × 6
##   country continent  year lifeExp        pop gdpPercap
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;      &lt;int&gt;     &lt;dbl&gt;
## 1 China   Asia       1972    63.1  862030000      677.
## 2 China   Asia       1977    64.0  943455000      741.
## 3 China   Asia       1982    65.5 1000281000      962.
## 4 China   Asia       1987    67.3 1084035000     1379.
## 5 China   Asia       1992    68.7 1164970000     1656.
## 6 China   Asia       1997    70.4 1230075000     2289.
## 7 China   Asia       2002    72.0 1280400000     3119.
## 8 China   Asia       2007    73.0 1318683096     4959.
```

---
class: inverse

.sectionhead[Part 2: Data Visualization]
---
layout: true

# Data Visualization
---

`ggplot2` is a fantastic way to make complex publication quality&lt;sup&gt;1&lt;/sup&gt; images
without much pre-processing of your data.
Plots are built sequentially using layers, so it's easy to edit and fine-tune the plots you generate.

When using `ggplot2`, it is *essential* that your data are tidy!
If they are not, the functions probably will not look like you expect.

Let's work through how to build a plot layer by layer.

.footnote[[1] or STAT302 Project quality]

---

First, let's initialize a plot. Use the `data` parameter to tell `ggplot` what data frame to use.

* It should be tidy data, in either a `data.frame` or `tibble`!

.pull-left[

```r
*ggplot(data = gapminder)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;
]

---

Add an aesthetic using the function `aes()` within the initial `ggplot()` call.

* Controls our axes variables as well as graphical parameters such as color, size, shape

.pull-left[

```r
ggplot(data = gapminder,
*      aes(x = year, y = lifeExp))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-13-1.png)&lt;!-- --&gt;
]

---

Now `ggplot` knows what to plot, but it doesn't know how to plot it yet. Let's add some points with `geom_point()`.

* This is a new layer! We add layers using the `+` operator.


.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_point()
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-15-1.png)&lt;!-- --&gt;
]

---

Let's make our points smaller and red.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_point(color = "red", size = 0.75)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;
]

---

Let's try switching them to lines.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_line(color = "red", size = 0.75)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;
]

---

We want lines connected by country, not just in the order they appear in the data.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
*          group = country)) +
  geom_line(color = "red", size = 0.5) 
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;
]

---

We want to explore differences across continents, so let's color by continent

* We use `aes()` because we want to color by something in our data
* Putting a color within `aes()` will automatically add a label
* We have to remove the color within `geom_line()`, or it will override the `aes()`


.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
*          color = continent)) +
* geom_line(size = 0.5)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;
]

---

Let's add another layer. Trendlines by continent!

* We want them grouped differently than our lines (by continent), so we use a new `aes()`
* We will make them stick out by having them be thicker and black
* We don't want error bars, so we will remove `se`
* We will use the default option `loess`. (See `?geom_smooth()`)

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
* geom_smooth(aes(group = continent),
*             se = FALSE, size = 1.5,
*             color = "black",
*             method = "loess")
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-25-1.png)&lt;!-- --&gt;
]

---


This is cluttered and hard to read. Let's try separating by continents using **facets**!

* We use `facet_wrap` 
* Takes in a **formula** object. Use a tilde `~` and then the variable name you want

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, 
              color = "black", 
              method = "loess") +
* facet_wrap(~ continent)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;
]

---

Looking better! Now let's fine tune. First we'll formalize the labels on our plot using `labs()`.

* Can also edit labels one at a time using `xlab()`, `ylab()`, `ggmain()`, ...
* You should probably do this in every graph you present! Very rarely do you want the text styling of your data frame to match your output. Emphasis here on human readability!

---


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, 
              color = "black", 
              method = "loess") +
  facet_wrap(~ continent) +
* labs(title = "Life expectancy over time by continent",
*      x = "Year", y = "Life Expectancy",
*      legend = "Continent")
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-29-1.png)&lt;!-- --&gt;
]

---

Let's center our title by adjusting `theme()`.

* `element_text()` tells ggplot how to display the text. Used for fine-tuning
* `hjust` is our horizontal alignment, we set it to one half



```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy", legend = "Continent") +
* theme(plot.title = element_text(hjust = 0.5,
*                                 face = "bold",
*                                 size = 14))
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-31-1.png)&lt;!-- --&gt;
]

---

Actually, that legend is redundant. Let's remove it.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
*       legend.position = "none")
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-33-1.png)&lt;!-- --&gt;
]

---

I don't like the default gray background. I almost always set the `theme_bw()`.

* There are several other theme options! Too many to list, so look them up if you want more options.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        legend.position = "none") +
* theme_bw()
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-35-1.png)&lt;!-- --&gt;
]

---

This overwrote our custome `theme()` settings! Let's reorder the layers.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
* theme_bw() +
* theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
*       legend.position = "none")
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-37-1.png)&lt;!-- --&gt;
]

---

We can make this more readable. Be careful of text that is too small! 
Let's increase all of our text proportionally using `base_size` within `theme_bw()`.

* We could also do this by adjusting `text` within `theme()`
* Note that we no longer need to manually adjust our title size. This will scale everything automatically.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
* theme_bw(base_size = 16) +
* theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "none") 
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-39-1.png)&lt;!-- --&gt;
]


---

Almost there! Now our text is a good size, but it overlaps. There are a few ways we could fix this. We'll rotate our text.



```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
*       axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-41-1.png)&lt;!-- --&gt;
]

---

Lastly, let's space out our panels by adjusting `panel.spacing.x`.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
*       panel.spacing.x = unit(0.75, "cm"))
```

---

.middler[
![](03_datavizmanip_files/figure-html/unnamed-chunk-43-1.png)&lt;!-- --&gt;
]

---

Great, that looks good! Now we can store it as an object.


```r
*lifeExp_plot &lt;- ggplot(data = gapminder,
                       aes(x = year, y = lifeExp,
                           group = country,
                           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.spacing.x = unit(0.75, "cm")) 
```

---

Then we can plot it by just calling our object.


```r
lifeExp_plot
```

.center[
![](03_datavizmanip_files/figure-html/unnamed-chunk-46-1.png)&lt;!-- --&gt;
]

---


We can also save it in our `Figures` subfolder using `ggsave()`.

* Set `height` and `width` parameters to automatically resize the image



```r
ggsave(filename = "Figures/lifeExp_plot.pdf", plot = lifeExp_plot,
       height = 5, width = 7)
```

.center[**Never** save a figure from your analysis using screenshots or point-and-click!

They will be lower quality and non-reproducible!]

---

## Some comments on `ggplot`:

* What we just made was a *very* complicated and fine-tuned plot!
* I have to Google how to adjust certain things all the time
* So does the creator of `ggplot2`

.center[![hadley](images/hadley.png)]

---

## A simpler example: Histogram

.pull-left[

```r
*ggplot(data = gapminder,
*      aes(x = lifeExp))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-49-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
* geom_histogram()
```
]

.pull-right[

```
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
```

![](03_datavizmanip_files/figure-html/unnamed-chunk-51-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
* geom_histogram(binwidth = 1)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-53-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
*                color = "black",
*                fill = "lightblue")
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-55-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
                 color = "black", 
                 fill = "lightblue") +
* theme_bw(base_size = 20)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-57-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
                 color = "black", 
                 fill = "lightblue") +
  theme_bw(base_size = 20) +
* labs(x = "Life Expectancy",
*      y = "Count")
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-59-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
*ggplot(data = gapminder,
*      aes(x = continent, y = lifeExp))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-61-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
* geom_boxplot()
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-63-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
* geom_boxplot(fill = "lightblue")
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-65-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
* theme_bw(base_size = 20)
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-67-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
* labs(title = "Life expectancy by Continent",
*      x = "",
*      y = "")
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-69-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
  labs(title = "Life expectancy by Continent", 
       x = "", 
       y = "") +
* theme(plot.title =
*         element_text(hjust = 0.5))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-71-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
  labs(title = "Life expectancy by Continent", 
       x = "", 
       y = "") +
  theme(plot.title =
          element_text(hjust = 0.5)) +
* ylim(c(0, 85))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-73-1.png)&lt;!-- --&gt;
]

---

.pull-left[## Don'ts
* 3D plots
* Deceptive axes
* Excessive/bad coloring
* Bad variable/axis names
* Unreadable labels
* Overloaded with information
* Pie charts (usually)
]

.pull-right[## Do's
* Simple, clean graphics
* Neat and human readable text
* Appropriate data range (bar charts should *always* start from 0!)
* Consistent intervals
* Roughly ~6 colors or less
* Size figures appropriately
]

---
layout: false

# ggplot cheatsheet

* Axes: `xlim()`, `ylim()`
* Legends: within initial `aes()`, edit within `theme()` or `guides()`
* `geom_point()`, `geom_line()`, `geom_histogram()`, `geom_bar()`, `geom_boxplot()`, `geom_text()`
* `facet_grid()`, `facet_wrap()` for faceting
* `labs()` for labels
* `theme_bw()` to make things look nicer
* Graphical parameters: `color` for color, `alpha` for opacity, `lwd`/`size` for thickness, `shape` for shape, `fill` for interior color, ...

.pushdown[.center[[Much, much more! (Click me for a cheat sheet!)](https://rstudio.com/resources/cheatsheets/)]]

---

# What plot to use?

* What if you have 1 variable? 2 variables?
* What if you have numeric data? What about categorical?

---

# One numeric variable: histogram 
## `geom_histogram()`

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-74-1.png" style="display: block; margin: auto;" /&gt;

---

# One numeric variable: boxplot
## `geom_boxplot()`

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-75-1.png" style="display: block; margin: auto;" /&gt;

---

# One categorical variable: bar chart
## `geom_bar()`

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-76-1.png" style="display: block; margin: auto;" /&gt;

---

# One numeric and one categorical variable
## `geom_boxplot()`

Here, we have multiple observations for each category. 

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-77-1.png" style="display: block; margin: auto;" /&gt;

---

# One numeric and one categorical variable
## `geom_bar()` (with argument `stat = "identity"`)

Here we have only one observation per category.

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-78-1.png" style="display: block; margin: auto;" /&gt;

---

# Two numeric variables: scatterplot
## `geom_point()`

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-79-1.png" style="display: block; margin: auto;" /&gt;

---

# Two numeric variables, one time-based
## `geom_line()`

Hint: often when I make a line plot I like to use both `geom_point()` and `geom_line()`! 

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-80-1.png" style="display: block; margin: auto;" /&gt;

---

# Two categorical variables
## `geom_bar()` setting `x` and `fill` within `aes()`

&lt;img src="03_datavizmanip_files/figure-html/unnamed-chunk-81-1.png" style="display: block; margin: auto;" /&gt;

---

# Three variables 

* Two numeric variables and one categorical? 

--

  * Scatterplot or line plot colored by category 
  * Scatterplot or line plot faceted by category
  * Many possibilities! See slides 17-40! 

---

# Today's pet picture 


&lt;img src="../../files/images/pets/Macie_and_Bluto.jpeg" width="600px" style="display: block; margin: auto;" /&gt;

Thanks Moira!

---

# What about data manipulation?

What if we want to plot the differences between the minimum and maximum life expectancy for each country in Europe? 


```r
head(gapminder)
```

```
## # A tibble: 6 × 7
##   country     continent  year lifeExp      pop gdpPercap lifeExpCat
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
## 1 Afghanistan Asia       1952    28.8  8425333      779. FALSE     
## 2 Afghanistan Asia       1957    30.3  9240934      821. FALSE     
## 3 Afghanistan Asia       1962    32.0 10267083      853. FALSE     
## 4 Afghanistan Asia       1967    34.0 11537966      836. FALSE     
## 5 Afghanistan Asia       1972    36.1 13079460      740. FALSE     
## 6 Afghanistan Asia       1977    38.4 14880372      786. FALSE
```

---

# What about data manipulation?

What if we want to plot the differences between the minimum and maximum life expectancy for each country in Europe? 

We know how to filter the data to only include data in Europe. 


```r
gapminder %&gt;% 
  filter(continent == "Europe") %&gt;%
  head()
```

```
## # A tibble: 6 × 7
##   country continent  year lifeExp     pop gdpPercap lifeExpCat
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
## 1 Albania Europe     1952    55.2 1282697     1601. FALSE     
## 2 Albania Europe     1957    59.3 1476505     1942. FALSE     
## 3 Albania Europe     1962    64.8 1728137     2313. TRUE      
## 4 Albania Europe     1967    66.2 1984060     2760. TRUE      
## 5 Albania Europe     1972    67.7 2263554     3313. TRUE      
## 6 Albania Europe     1977    68.9 2509048     3533. TRUE
```

But what about the rest?
---

class: inverse

.sectionhead[Part 3: Data Manipulation]

---
layout: true

# &lt;TT&gt;select()&lt;/TT&gt;: Column selection

---

Use `select()` to choose certain columns.


```r
gapminder %&gt;% 
  select(lifeExp, gdpPercap)
```

```
## # A tibble: 1,704 × 2
##    lifeExp gdpPercap
##      &lt;dbl&gt;     &lt;dbl&gt;
##  1    28.8      779.
##  2    30.3      821.
##  3    32.0      853.
##  4    34.0      836.
##  5    36.1      740.
##  6    38.4      786.
##  7    39.9      978.
##  8    40.8      852.
##  9    41.7      649.
## 10    41.8      635.
## # … with 1,694 more rows
```

---
Use `select()` to choose certain columns.
We can also use `select()` to remove certain columns by putting a `-` symbol in front.


```r
gapminder %&gt;% 
  select(-lifeExp, -gdpPercap)
```

```
## # A tibble: 1,704 × 5
##    country     continent  year      pop lifeExpCat
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;    &lt;int&gt; &lt;lgl&gt;     
##  1 Afghanistan Asia       1952  8425333 FALSE     
##  2 Afghanistan Asia       1957  9240934 FALSE     
##  3 Afghanistan Asia       1962 10267083 FALSE     
##  4 Afghanistan Asia       1967 11537966 FALSE     
##  5 Afghanistan Asia       1972 13079460 FALSE     
##  6 Afghanistan Asia       1977 14880372 FALSE     
##  7 Afghanistan Asia       1982 12881816 FALSE     
##  8 Afghanistan Asia       1987 13867957 FALSE     
##  9 Afghanistan Asia       1992 16317921 FALSE     
## 10 Afghanistan Asia       1997 22227415 FALSE     
## # … with 1,694 more rows
```

---

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
names(gapminder)
```

```
## [1] "country"    "continent"  "year"       "lifeExp"    "pop"       
## [6] "gdpPercap"  "lifeExpCat"
```

```r
gapminder %&gt;%
  select(starts_with("co")) %&gt;%
  head()
```

```
## # A tibble: 6 × 2
##   country     continent
##   &lt;fct&gt;       &lt;fct&gt;    
## 1 Afghanistan Asia     
## 2 Afghanistan Asia     
## 3 Afghanistan Asia     
## 4 Afghanistan Asia     
## 5 Afghanistan Asia     
## 6 Afghanistan Asia
```

---

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
names(gapminder)
```

```
## [1] "country"    "continent"  "year"       "lifeExp"    "pop"       
## [6] "gdpPercap"  "lifeExpCat"
```

```r
gapminder %&gt;%
  select(ends_with("p")) %&gt;%
  head()
```

```
## # A tibble: 6 × 3
##   lifeExp      pop gdpPercap
##     &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1    28.8  8425333      779.
## 2    30.3  9240934      821.
## 3    32.0 10267083      853.
## 4    34.0 11537966      836.
## 5    36.1 13079460      740.
## 6    38.4 14880372      786.
```

---

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
names(gapminder)
```

```
## [1] "country"    "continent"  "year"       "lifeExp"    "pop"       
## [6] "gdpPercap"  "lifeExpCat"
```

```r
gapminder %&gt;%
  select(contains("Per")) %&gt;%
  head()
```

```
## # A tibble: 6 × 1
##   gdpPercap
##       &lt;dbl&gt;
## 1      779.
## 2      821.
## 3      853.
## 4      836.
## 5      740.
## 6      786.
```
---

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings

This can be particularly helpful when you have data in "wide" format! (such as `category_01`, `category_02`, `category_03`, ...)


---
layout: false
layout: true

# &lt;TT&gt;mutate()&lt;/TT&gt;: create new columns


Create and transform variables from existing variables using `mutate()`. 

`mutate(NEW_VAR_NAME = ...)`.

---


```r
gapminder %&gt;%
  mutate(gdp = gdpPercap * pop) %&gt;%
  head()
```

```
## # A tibble: 6 × 8
##   country     continent  year lifeExp      pop gdpPercap lifeExpCat          gdp
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;             &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8  8425333      779. FALSE       6567086330.
## 2 Afghanistan Asia       1957    30.3  9240934      821. FALSE       7585448670.
## 3 Afghanistan Asia       1962    32.0 10267083      853. FALSE       8758855797.
## 4 Afghanistan Asia       1967    34.0 11537966      836. FALSE       9648014150.
## 5 Afghanistan Asia       1972    36.1 13079460      740. FALSE       9678553274.
## 6 Afghanistan Asia       1977    38.4 14880372      786. FALSE      11697659231.
```

---

Note that we can use existing columns, including those we created within the same call to `mutate()`.


```r
gapminder %&gt;%
  mutate(gdp = gdpPercap * pop,
         logGDP = log(gdp)) %&gt;% 
  head()
```

```
## # A tibble: 6 × 9
##   country     continent  year lifeExp    pop gdpPercap lifeExpCat     gdp logGDP
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt;  &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8 8.43e6      779. FALSE      6.57e 9   22.6
## 2 Afghanistan Asia       1957    30.3 9.24e6      821. FALSE      7.59e 9   22.7
## 3 Afghanistan Asia       1962    32.0 1.03e7      853. FALSE      8.76e 9   22.9
## 4 Afghanistan Asia       1967    34.0 1.15e7      836. FALSE      9.65e 9   23.0
## 5 Afghanistan Asia       1972    36.1 1.31e7      740. FALSE      9.68e 9   23.0
## 6 Afghanistan Asia       1977    38.4 1.49e7      786. FALSE      1.17e10   23.2
```

---
layout: false
layout: true
# &lt;TT&gt;ifelse()&lt;/TT&gt;: conditional selection

---

`ifelse()` takes in a logical test and conditional responses, and returns a vector of values based on the output of the test. It can be very useful for data cleaning (among other uses)!

`ifelse(test, yes, no)`

* `test`: the logical test
* `yes`: return values for when `test` is `TRUE`
* `no`: return values for when `test` is `FALSE`


```r
demo &lt;- -2:2
demo &gt; 0
```

```
## [1] FALSE FALSE FALSE  TRUE  TRUE
```

```r
ifelse(demo &gt; 0, "strictly positive", "not strictly positive")
```

```
## [1] "not strictly positive" "not strictly positive" "not strictly positive"
## [4] "strictly positive"     "strictly positive"
```

---

`ifelse()` can be very useful within `mutate()`.
For example, if we want to use the country code `USA` instead of `United States`, and store this variable `country_clean` as a character type instead of a factor, we can use:


```r
gapminder %&gt;%
  mutate(country_clean =
           ifelse(country == "United States",
                  "USA", as.character(country))) %&gt;%
  filter(year == 2007,
         continent == "Americas") %&gt;%
  select(country, country_clean) %&gt;%
  tail()
```

```
## # A tibble: 6 × 2
##   country             country_clean      
##   &lt;fct&gt;               &lt;chr&gt;              
## 1 Peru                Peru               
## 2 Puerto Rico         Puerto Rico        
## 3 Trinidad and Tobago Trinidad and Tobago
## 4 United States       USA                
## 5 Uruguay             Uruguay            
## 6 Venezuela           Venezuela
```

---
layout: false
layout: true
# &lt;TT&gt;%in%&lt;/TT&gt;: value matching

`%in%` is a binary operator, which returns a boolean vector indicating whether
components in the left-hand side are found in the right-hand side.

---


```r
1 %in% 1:5
```

```
## [1] TRUE
```

```r
1 %in% -1:-5
```

```
## [1] FALSE
```

```r
c(0, 1, 2, 7) %in% 1:5
```

```
## [1] FALSE  TRUE  TRUE FALSE
```

---

To negate the `%in%` operator, wrap the entire logical statement within `!(...)`.


```r
!(1 %in% 1:5)
```

```
## [1] FALSE
```

```r
!(1 %in% -1:-5)
```

```
## [1] TRUE
```

```r
!(c(0, 1, 2, 7) %in% 1:5)
```

```
## [1]  TRUE FALSE FALSE  TRUE
```


---


```r
gapminder %&gt;%
  filter(continent %in% c("Americas", "Europe")) %&gt;%
  filter(year %in% c(2002, 2007)) %&gt;%
  head()
```

```
## # A tibble: 6 × 7
##   country   continent  year lifeExp      pop gdpPercap lifeExpCat
##   &lt;fct&gt;     &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
## 1 Albania   Europe     2002    75.7  3508512     4604. TRUE      
## 2 Albania   Europe     2007    76.4  3600523     5937. TRUE      
## 3 Argentina Americas   2002    74.3 38331121     8798. TRUE      
## 4 Argentina Americas   2007    75.3 40301927    12779. TRUE      
## 5 Austria   Europe     2002    79.0  8148312    32418. TRUE      
## 6 Austria   Europe     2007    79.8  8199783    36126. TRUE
```

---
layout: false
layout: true
# split-apply-combine

---
*split-apply-combine* is a data analysis strategy where you *split* the data up into pieces, *apply* some operation on each piece, and then *combine* all the pieces back together. 
It's useful for breaking big problems into smaller manageable chunks!

---

## `group_by()`

You can use `group_by()` to define a grouping of the rows of your data based on the columns.
Notice that it doesn't change our data, except for that we can now see that it has 5 groups.


```r
grouped_gap &lt;- gapminder %&gt;%
  group_by(continent)
class(grouped_gap)
```

```
## [1] "grouped_df" "tbl_df"     "tbl"        "data.frame"
```

```r
head(grouped_gap, 4)
```

```
## # A tibble: 4 × 7
## # Groups:   continent [1]
##   country     continent  year lifeExp      pop gdpPercap lifeExpCat
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
## 1 Afghanistan Asia       1952    28.8  8425333      779. FALSE     
## 2 Afghanistan Asia       1957    30.3  9240934      821. FALSE     
## 3 Afghanistan Asia       1962    32.0 10267083      853. FALSE     
## 4 Afghanistan Asia       1967    34.0 11537966      836. FALSE
```

---

## `group_by()`

You can use `group_by()` to define a grouping of the rows of your data based on the columns.
We can remove the groups with `ungroup()`.


```r
ungrouped_gap &lt;- ungroup(grouped_gap)
class(ungrouped_gap)
```

```
## [1] "tbl_df"     "tbl"        "data.frame"
```

```r
head(ungrouped_gap)
```

```
## # A tibble: 6 × 7
##   country     continent  year lifeExp      pop gdpPercap lifeExpCat
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
## 1 Afghanistan Asia       1952    28.8  8425333      779. FALSE     
## 2 Afghanistan Asia       1957    30.3  9240934      821. FALSE     
## 3 Afghanistan Asia       1962    32.0 10267083      853. FALSE     
## 4 Afghanistan Asia       1967    34.0 11537966      836. FALSE     
## 5 Afghanistan Asia       1972    36.1 13079460      740. FALSE     
## 6 Afghanistan Asia       1977    38.4 14880372      786. FALSE
```

---

## `summarize()`

`summarize()` (or `summarise()`, if you prefer) will apply functions to rows of a data frame. If a data frame is grouped, the function will be applied by group.


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap))
```

```
## # A tibble: 5 × 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Africa            48.9  21951.
## 2 Americas          64.7  42952.
## 3 Asia              60.1 113523.
## 4 Europe            71.9  49357.
## 5 Oceania           74.3  34435.
```

Notice that this creates an entirely new (and much smaller) data frame. Typically we want to store this object as a variable, but not as the same variable as our data!

---

## `arrange()`

We can order the rows of the data using `arrange()`. Usually, you do this after some call to `summarize()`. 


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap)) %&gt;%
  arrange(mean_lifeExp)
```

```
## # A tibble: 5 × 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Africa            48.9  21951.
## 2 Asia              60.1 113523.
## 3 Americas          64.7  42952.
## 4 Europe            71.9  49357.
## 5 Oceania           74.3  34435.
```

---

## `arrange()`

We can order the rows of the data using `arrange()`. Usually, you do this after some call to `summarize()`. We can use `desc()` to put in decreasing order.


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap)) %&gt;%
  arrange(desc(mean_lifeExp))
```

```
## # A tibble: 5 × 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Oceania           74.3  34435.
## 2 Europe            71.9  49357.
## 3 Americas          64.7  42952.
## 4 Asia              60.1 113523.
## 5 Africa            48.9  21951.
```


---
layout:false 

# &lt;TT&gt;pull()&lt;/TT&gt;: extract column as vector

You can use `pull()` to extract a single column as a vector. Notice the difference between


```r
gapminder %&gt;%
  select(lifeExp) %&gt;%
  head(4)
```

```
## # A tibble: 4 × 1
##   lifeExp
##     &lt;dbl&gt;
## 1    28.8
## 2    30.3
## 3    32.0
## 4    34.0
```


```r
gapminder %&gt;%
  pull(lifeExp) %&gt;%
  head(10)
```

```
##  [1] 28.801 30.332 31.997 34.020 36.088 38.438 39.854 40.822 41.674 41.763
```


---
# &lt;TT&gt;rename()&lt;/TT&gt;: ...renaming!

`rename(data, NEW_VAR_NAME = OLD_VAR_NAME)`


```r
gapminder %&gt;%
  rename(life_exp = lifeExp)
```

```
## # A tibble: 1,704 × 7
##    country     continent  year life_exp      pop gdpPercap lifeExpCat
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;    &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;lgl&gt;     
##  1 Afghanistan Asia       1952     28.8  8425333      779. FALSE     
##  2 Afghanistan Asia       1957     30.3  9240934      821. FALSE     
##  3 Afghanistan Asia       1962     32.0 10267083      853. FALSE     
##  4 Afghanistan Asia       1967     34.0 11537966      836. FALSE     
##  5 Afghanistan Asia       1972     36.1 13079460      740. FALSE     
##  6 Afghanistan Asia       1977     38.4 14880372      786. FALSE     
##  7 Afghanistan Asia       1982     39.9 12881816      978. FALSE     
##  8 Afghanistan Asia       1987     40.8 13867957      852. FALSE     
##  9 Afghanistan Asia       1992     41.7 16317921      649. FALSE     
## 10 Afghanistan Asia       1997     41.8 22227415      635. FALSE     
## # … with 1,694 more rows
```


---
layout: true

# Re-arranging Data

---

## `pivot_longer()`

Let's load the `relig_income` data from tidyverse.


```r
data(relig_income)
head(relig_income)
```

```
## # A tibble: 6 × 11
##   religion  `&lt;$10k` `$10-20k` `$20-30k` `$30-40k` `$40-50k` `$50-75k` `$75-100k`
##   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
## 1 Agnostic       27        34        60        81        76       137        122
## 2 Atheist        12        27        37        52        35        70         73
## 3 Buddhist       27        21        30        34        33        58         62
## 4 Catholic      418       617       732       670       638      1116        949
## 5 Don’t kn…      15        14        15        11        10        35         21
## 6 Evangeli…     575       869      1064       982       881      1486        949
## # … with 3 more variables: $100-150k &lt;dbl&gt;, &gt;150k &lt;dbl&gt;,
## #   Don't know/refused &lt;dbl&gt;
```

---

## `pivot_longer()`

We can use `pivot_longer()` to go from data in "wide" form to data in "long" form.


```r
relig_income %&gt;%
  pivot_longer(cols = contains("$"), 
               names_to = "income",  
               values_to = "count")
```

```
## # A tibble: 144 × 5
##    religion `&gt;150k` `Don't know/refused` income    count
##    &lt;chr&gt;      &lt;dbl&gt;                &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 Agnostic      84                   96 &lt;$10k        27
##  2 Agnostic      84                   96 $10-20k      34
##  3 Agnostic      84                   96 $20-30k      60
##  4 Agnostic      84                   96 $30-40k      81
##  5 Agnostic      84                   96 $40-50k      76
##  6 Agnostic      84                   96 $50-75k     137
##  7 Agnostic      84                   96 $75-100k    122
##  8 Agnostic      84                   96 $100-150k   109
##  9 Atheist       74                   76 &lt;$10k        12
## 10 Atheist       74                   76 $10-20k      27
## # … with 134 more rows
```

---

## `pivot_longer()`

Looks like we missed a few of the income column names. 


```r
relig_income %&gt;%
  pivot_longer(cols = c(contains("$"), "&gt;150k", "Don't know/refused"), 
               names_to = "income",
               values_to = "count") 
```

```
## # A tibble: 180 × 3
##    religion income             count
##    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;
##  1 Agnostic &lt;$10k                 27
##  2 Agnostic $10-20k               34
##  3 Agnostic $20-30k               60
##  4 Agnostic $30-40k               81
##  5 Agnostic $40-50k               76
##  6 Agnostic $50-75k              137
##  7 Agnostic $75-100k             122
##  8 Agnostic $100-150k            109
##  9 Agnostic &gt;150k                 84
## 10 Agnostic Don't know/refused    96
## # … with 170 more rows
```

---
## `pivot_longer()`

Let's load the `billboard` data from tidyverse.


```r
data(billboard)
head(billboard)
```

```
## # A tibble: 6 × 79
##   artist   track    date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8
##   &lt;chr&gt;    &lt;chr&gt;    &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 2 Pac    Baby Do… 2000-02-26      87    82    72    77    87    94    99    NA
## 2 2Ge+her  The Har… 2000-09-02      91    87    92    NA    NA    NA    NA    NA
## 3 3 Doors… Krypton… 2000-04-08      81    70    68    67    66    57    54    53
## 4 3 Doors… Loser    2000-10-21      76    76    72    69    67    65    55    59
## 5 504 Boyz Wobble … 2000-04-15      57    34    25    17    17    31    36    49
## 6 98^0     Give Me… 2000-08-19      51    39    34    26    26    19     2     2
## # … with 68 more variables: wk9 &lt;dbl&gt;, wk10 &lt;dbl&gt;, wk11 &lt;dbl&gt;, wk12 &lt;dbl&gt;,
## #   wk13 &lt;dbl&gt;, wk14 &lt;dbl&gt;, wk15 &lt;dbl&gt;, wk16 &lt;dbl&gt;, wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;,
## #   wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;, wk22 &lt;dbl&gt;, wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;,
## #   wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;, wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;,
## #   wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;, wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;,
## #   wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;, wk40 &lt;dbl&gt;, wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;,
## #   wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;, wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;, …
```

---
## `pivot_longer()`


```r
billboard %&gt;%
 pivot_longer(
   cols = starts_with("wk"),
   names_to = "week",
   names_prefix = "wk",
   values_to = "rank",
   values_drop_na = TRUE
 ) %&gt;% 
  head(8)
```

```
## # A tibble: 8 × 5
##   artist  track                   date.entered week   rank
##   &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
## 1 2 Pac   Baby Don't Cry (Keep... 2000-02-26   1        87
## 2 2 Pac   Baby Don't Cry (Keep... 2000-02-26   2        82
## 3 2 Pac   Baby Don't Cry (Keep... 2000-02-26   3        72
## 4 2 Pac   Baby Don't Cry (Keep... 2000-02-26   4        77
## 5 2 Pac   Baby Don't Cry (Keep... 2000-02-26   5        87
## 6 2 Pac   Baby Don't Cry (Keep... 2000-02-26   6        94
## 7 2 Pac   Baby Don't Cry (Keep... 2000-02-26   7        99
## 8 2Ge+her The Hardest Part Of ... 2000-09-02   1        91
```

---
## `pivot_wider()`

Let's load the `fish_encounters` data from tidyverse.


```r
data(fish_encounters)
head(fish_encounters, 12)
```

```
## # A tibble: 12 × 3
##    fish  station  seen
##    &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;
##  1 4842  Release     1
##  2 4842  I80_1       1
##  3 4842  Lisbon      1
##  4 4842  Rstr        1
##  5 4842  Base_TD     1
##  6 4842  BCE         1
##  7 4842  BCW         1
##  8 4842  BCE2        1
##  9 4842  BCW2        1
## 10 4842  MAE         1
## 11 4842  MAW         1
## 12 4843  Release     1
```

---

## `pivot_wider()`

We can use `pivot_wider()` to go from data in "long" form to data in "wide" form.


```r
fish_encounters %&gt;%
  pivot_wider(names_from = station, values_from = seen) %&gt;%
  head(12)
```

```
## # A tibble: 12 × 12
##    fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##    &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 4842        1     1      1     1       1     1     1     1     1     1     1
##  2 4843        1     1      1     1       1     1     1     1     1     1     1
##  3 4844        1     1      1     1       1     1     1     1     1     1     1
##  4 4845        1     1      1     1       1    NA    NA    NA    NA    NA    NA
##  5 4847        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA
##  6 4848        1     1      1     1      NA    NA    NA    NA    NA    NA    NA
##  7 4849        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
##  8 4850        1     1     NA     1       1     1     1    NA    NA    NA    NA
##  9 4851        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 10 4854        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 11 4855        1     1      1     1       1    NA    NA    NA    NA    NA    NA
## 12 4857        1     1      1     1       1     1     1     1     1    NA    NA
```


---

## `pivot_wider()`


```r
fish_encounters %&gt;%
  pivot_wider(
    names_from = station,
    values_from = seen,
    values_fill = list(seen = 0)
  ) %&gt;%
  head(9)
```

```
## # A tibble: 9 × 12
##   fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##   &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1 4842        1     1      1     1       1     1     1     1     1     1     1
## 2 4843        1     1      1     1       1     1     1     1     1     1     1
## 3 4844        1     1      1     1       1     1     1     1     1     1     1
## 4 4845        1     1      1     1       1     0     0     0     0     0     0
## 5 4847        1     1      1     0       0     0     0     0     0     0     0
## 6 4848        1     1      1     1       0     0     0     0     0     0     0
## 7 4849        1     1      0     0       0     0     0     0     0     0     0
## 8 4850        1     1      0     1       1     1     1     0     0     0     0
## 9 4851        1     1      0     0       0     0     0     0     0     0     0
```


---
## `pivot_wider()`

Let's load the `us_rent_income` data from tidyverse.


```r
data(us_rent_income)
head(us_rent_income)
```

```
## # A tibble: 6 × 5
##   GEOID NAME    variable estimate   moe
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
## 1 01    Alabama income      24476   136
## 2 01    Alabama rent          747     3
## 3 02    Alaska  income      32940   508
## 4 02    Alaska  rent         1200    13
## 5 04    Arizona income      27517   148
## 6 04    Arizona rent          972     4
```

---

## `pivot_wider()`


```r
us_rent_income %&gt;%
  pivot_wider(names_from = variable, values_from = c(estimate, moe))
```

```
## # A tibble: 52 × 6
##    GEOID NAME                 estimate_income estimate_rent moe_income moe_rent
##    &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 01    Alabama                        24476           747        136        3
##  2 02    Alaska                         32940          1200        508       13
##  3 04    Arizona                        27517           972        148        4
##  4 05    Arkansas                       23789           709        165        5
##  5 06    California                     29454          1358        109        3
##  6 08    Colorado                       32401          1125        109        5
##  7 09    Connecticut                    35326          1123        195        5
##  8 10    Delaware                       31560          1076        247       10
##  9 11    District of Columbia           43198          1424        681       17
## 10 12    Florida                        25952          1077         70        3
## # … with 42 more rows
```

---
layout: false
layout: true

# Joining Data

---

We can use SQL-like join statements in R!


* `inner_join(x, y, by = "key")`: match observations only when exact keys are equal
* `left_join(x, y, by = "key")`: keep all observations in `x`, match observations in `y` by keys, `NA` otherwise
* `right_join(x, y, by = "key")`: keep all observations in `y`, match observations in `x` by keys, `NA` otherwise
* `full_join(x, y, by = "key")`: keep all observations in `x` and `y`, match keys where possible, `NA` otherwise




.pull-left[

```r
x
```

```
##   id   name
## 1  1 Nutmeg
## 2  2    Pig
## 3  3   Duke
```
]

.pull-right[

```r
y
```

```
##   id animal
## 1  1    cat
## 2  2    dog
## 3  4   bird
```
]

---
## Inner join 


```r
x
```

```
##   id   name
## 1  1 Nutmeg
## 2  2    Pig
## 3  3   Duke
```

```r
y
```

```
##   id animal
## 1  1    cat
## 2  2    dog
## 3  4   bird
```

```r
inner_join(x, y, by = "id")
```

```
##   id   name animal
## 1  1 Nutmeg    cat
## 2  2    Pig    dog
```

---

## Left join 


```r
x
```

```
##   id   name
## 1  1 Nutmeg
## 2  2    Pig
## 3  3   Duke
```

```r
y
```

```
##   id animal
## 1  1    cat
## 2  2    dog
## 3  4   bird
```

```r
left_join(x, y, by = "id")
```

```
##   id   name animal
## 1  1 Nutmeg    cat
## 2  2    Pig    dog
## 3  3   Duke   &lt;NA&gt;
```

---

## Right join 


```r
x
```

```
##   id   name
## 1  1 Nutmeg
## 2  2    Pig
## 3  3   Duke
```

```r
y
```

```
##   id animal
## 1  1    cat
## 2  2    dog
## 3  4   bird
```

```r
right_join(x, y, by = "id")
```

```
##   id   name animal
## 1  1 Nutmeg    cat
## 2  2    Pig    dog
## 3  4   &lt;NA&gt;   bird
```

---

## Full join 


```r
x
```

```
##   id   name
## 1  1 Nutmeg
## 2  2    Pig
## 3  3   Duke
```

```r
y
```

```
##   id animal
## 1  1    cat
## 2  2    dog
## 3  4   bird
```

```r
full_join(x, y, by = "id")
```

```
##   id   name animal
## 1  1 Nutmeg    cat
## 2  2    Pig    dog
## 3  3   Duke   &lt;NA&gt;
## 4  4   &lt;NA&gt;   bird
```

---

.center[&lt;img src="images/join-inner.png" alt="" height="100"/&gt;]
.center[&lt;img src="images/join-outer.png" alt="" height="380"/&gt;]


.footnote[Images courtesy of Hadley Wickham. ([Link](https://r4ds.had.co.nz/relational-data.html))]

---
layout: false

# dplyr cheatsheet

* `filter()` subset rows
* `select()` subset columns, use with `contains()`, `starts_with()`, `ends_with()`, ...
* `mutate()` create columns
* `group_by()`, `summarize()`, `count()` group and summarize groups
* `rename()` rename columns
* `pivot_longer()`, `pivot_wider()` reshape data
* `inner_join()`, `left_join()`, `right_join()`, `outer_join()` combine data (like SQL)

.pushdown[.center[[Much, much more! (Click me for a cheat sheet!)](https://rstudio.com/resources/cheatsheets/)]]


---

# Back to our earlier example

What if we want to plot the differences between the minimum and maximum life expectancy for each country in Europe? Let's only consider countries with the ten largest differences. 

---

# Back to our earlier example

What if we want to plot the differences between the minimum and maximum life expectancy for each country in Europe? Let's only consider countries with the ten largest differences. 


```r
lifeExpDiff &lt;- gapminder %&gt;% 
  filter(continent == "Europe") %&gt;% 
  group_by(country) %&gt;%
  summarise(minLifeExp = min(lifeExp),
            maxLifeExp = max(lifeExp),
            lifeExpDiff = maxLifeExp - minLifeExp) %&gt;% 
  arrange(desc(lifeExpDiff)) %&gt;%
  head(10)
head(lifeExpDiff)
```

```
## # A tibble: 6 × 4
##   country                minLifeExp maxLifeExp lifeExpDiff
##   &lt;fct&gt;                       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;
## 1 Turkey                       43.6       71.8        28.2
## 2 Albania                      55.2       76.4        21.2
## 3 Bosnia and Herzegovina       53.8       74.9        21.0
## 4 Portugal                     59.8       78.1        18.3
## 5 Montenegro                   59.2       75.4        16.3
## 6 Serbia                       58.0       74.0        16.0
```

---

# Back to our earlier example

What if we want to plot the differences between the minimum and maximum life expectancy for each country in Europe? Let's only consider countries with the ten largest differences. 

.pull-left[

```r
ggplot(data = lifeExpDiff, 
       aes(x = country, 
           y = lifeExpDiff)) + 
  geom_col() + 
  theme_bw(base_size = 14) + 
  labs(title = "Largest Life Expectancy Differences in Europe",
       x = "",
       y = "Life Expectancy Difference") + 
  theme(plot.title = 
          element_text(hjust = 0.5),
        axis.text.x = 
          element_text(angle = 45, 
                       hjust = 1, 
                       vjust = 1))
```
]

.pull-right[
![](03_datavizmanip_files/figure-html/unnamed-chunk-124-1.png)&lt;!-- --&gt;
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "default",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
